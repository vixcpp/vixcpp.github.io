(function(){"use strict";let i=null,c="";function d(t){return(t||"").toLowerCase()}function u(t,e){return e?d(t).includes(e):!0}function v(t){const e=t?.keywords;return Array.isArray(e)?e.filter(s=>typeof s=="string").join(", "):""}function m(t){if(typeof t?.latest=="string"&&t.latest)return t.latest;const e=t?.versions;if(!e||typeof e!="object")return"";let s="";for(const o of Object.keys(e))(!s||o>s)&&(s=o);return s}function A(t,e){const s=t?.namespace||"",o=t?.name||"",r=`${s}/${o}`;let n=0;if(!e)return 0;u(r,e)&&(n+=100),u(o,e)&&(n+=60),u(s,e)&&(n+=40),u(t?.displayName||"",e)&&(n+=25),u(t?.description||"",e)&&(n+=20);const a=v(t);return u(a,e)&&(n+=15),n}function g(t,e){const s=t?.namespace||"",o=t?.name||"",r=`${s}/${o}`,n=t?.repo&&typeof t.repo=="object"&&t.repo.url||"";return{id:r,namespace:s,name:o,displayName:t?.displayName||o,description:t?.description||"",repo:n,latest:m(t),score:Number(e)||0}}function M(t,e){const s=String(t||"").split("-")[0].split(".").map(r=>parseInt(r,10)||0),o=String(e||"").split("-")[0].split(".").map(r=>parseInt(r,10)||0);for(let r=0;r<3;r++){const n=s[r]??0,a=o[r]??0;if(n!==a)return a-n}return String(e||"").localeCompare(String(t||""))}function h(t,e){if(e==="latest"){t.sort((s,o)=>{const r=M(s.latest,o.latest);return r!==0?r:s.id.localeCompare(o.id)});return}t.sort((s,o)=>s.score!==o.score?o.score-s.score:s.id.localeCompare(o.id))}function k({limit:t=50,offset:e=0}={}){if(!i||!Array.isArray(i.entries))return{ok:!1,error:"registry_not_loaded",hits:[],version:c,total:0};const s=Math.max(1,Math.min(200,Number(t)||50)),o=Math.max(0,Number(e)||0),r=[];for(const n of i.entries)r.push(g(n,0));return h(r,"latest"),{ok:!0,version:c,total:r.length,hits:r.slice(o,o+s)}}function N(t){if(!i||!Array.isArray(i.entries))return null;const e=String(t||"").trim();if(!e)return null;for(const s of i.entries){const o=s?.namespace||"",r=s?.name||"";if(`${o}/${r}`===e)return s}return null}function j(t){const e=t?.versions&&typeof t.versions=="object"?t.versions:null,s=e?Object.keys(e):[],o=m(t),r=s.length,n=typeof t?.readme=="string"&&t.readme.trim().length>0,a=!!(t?.repo&&typeof t.repo=="object"&&t.repo.url),l=t?.createdAt||"",f=t?.updatedAt||t?.lastUpdatedAt||"";return{latest:o,versionsCount:r,hasReadme:n,hasRepo:a,createdAt:l,updatedAt:f}}function S(t){if(!t)return null;const e=t?.namespace||"",s=t?.name||"",o=`${e}/${s}`,r=t?.repo&&typeof t.repo=="object"&&t.repo.url||"";return{id:o,namespace:e,name:s,displayName:t?.displayName||s,description:t?.description||"",keywords:Array.isArray(t?.keywords)?t.keywords:[],repo:r,homepage:t?.homepage||"",license:t?.license||"",latest:m(t),stats:j(t),readme:typeof t?.readme=="string"?t.readme:""}}function w({query:t,limit:e=30,offset:s=0,sort:o="score"}={}){if(!i||!Array.isArray(i.entries))return{ok:!1,error:"registry_not_loaded",hits:[],version:c,total:0};const r=(t||"").trim(),n=d(r);if(!n)return k({limit:e,offset:s});const a=Math.max(1,Math.min(200,Number(e)||30)),l=Math.max(0,Number(s)||0),f=o==="latest"?"latest":"score",p=[];for(const y of i.entries){const b=A(y,n);b<=0||p.push(g(y,b))}return h(p,f),{ok:!0,version:c,total:p.length,hits:p.slice(l,l+a)}}self.onmessage=t=>{const e=t.data||{},s=e.type;if(s==="load"){i=e.data||null,c=i?.meta?.generatedAt||"",self.postMessage({type:"loaded",ok:!!i,version:c});return}if(s==="getPackage"){if(!i){self.postMessage({type:"packageResult",ok:!1,error:"registry_not_loaded",version:c,id:e.id||"",pkg:null});return}const o=String(e.id||"").trim(),r=N(o);if(!r){self.postMessage({type:"packageResult",ok:!1,error:"not_found",version:c,id:o,pkg:null});return}self.postMessage({type:"packageResult",ok:!0,version:c,id:o,pkg:S(r)});return}if(s==="search"){const r=(e.query||"").toString().trim(),n=!r,a=n?50:30,l=n?"latest":"score",f=n?k({limit:e.limit??a,offset:e.offset}):w({query:r,limit:e.limit??a,offset:e.offset,sort:e.sort??l});self.postMessage({type:"searchResult",...f,query:r,offset:Math.max(0,Number(e.offset)||0),limit:Math.max(1,Number(e.limit??a)||a),sort:(e.sort??l)==="latest"?"latest":"score",mode:n?"browse":"search"});return}self.postMessage({type:"error",error:"unknown_message_type"})}})();
