import{_ as a,o as i,c as e,a as n}from"./app.BYdyB00j.js";import"./chunks/markjs.l6TISjdC.js";import"./chunks/minisearch.DigTKvvb.js";const y=JSON.parse('{"title":"async/core cancel","description":"","frontmatter":{},"headers":[],"relativePath":"modules/async/cancel.md","filePath":"modules/async/cancel.md","lastUpdated":1770918867000}'),l={name:"modules/async/cancel.md"};function t(h,s,p,c,r,k){return i(),e("div",null,[...s[0]||(s[0]=[n(`<h1 id="async-core-cancel" tabindex="-1">async/core cancel <a class="header-anchor" href="#async-core-cancel" aria-label="Permalink to &quot;async/core cancel&quot;">​</a></h1><p>Cooperative cancellation primitives for Vix.cpp async code.</p><p>This header defines a tiny cancellation model:</p><ul><li><code>cancel_source</code>: the owner that can request cancellation</li><li><code>cancel_token</code>: a cheap observer you pass into async work</li><li><code>cancel_state</code>: shared state storing the atomic cancellation flag</li><li><code>cancelled_ec()</code>: a standard <code>std::error_code</code> for “operation canceled”</li></ul><p>The design is intentionally minimal and deterministic: no callbacks, no allocations on cancel, no surprises. It is safe to use across threads.</p><hr><h2 id="why-this-exists" tabindex="-1">Why this exists <a class="header-anchor" href="#why-this-exists" aria-label="Permalink to &quot;Why this exists&quot;">​</a></h2><p>In async systems, you often need a way to stop work early:</p><ul><li>user closes a request</li><li>shutdown begins</li><li>a timeout expires</li><li>one branch in a fan-out fails and you want to cancel the rest</li></ul><p><code>cancel_token</code> gives every task a fast “should I stop?” check. <code>cancel_source</code> lets a controller signal that stop.</p><hr><h2 id="key-types" tabindex="-1">Key types <a class="header-anchor" href="#key-types" aria-label="Permalink to &quot;Key types&quot;">​</a></h2><h3 id="cancel-state" tabindex="-1">cancel_state <a class="header-anchor" href="#cancel-state" aria-label="Permalink to &quot;cancel_state&quot;">​</a></h3><p>Shared internal object that holds the cancellation flag.</p><ul><li><code>request_cancel()</code> sets an atomic boolean to true</li><li><code>is_cancelled()</code> reads it</li></ul><p>Thread safety:</p><ul><li>writes use <code>memory_order_release</code></li><li>reads use <code>memory_order_acquire</code></li></ul><p>That is enough for a simple “flag” protocol across threads.</p><h3 id="cancel-token" tabindex="-1">cancel_token <a class="header-anchor" href="#cancel-token" aria-label="Permalink to &quot;cancel_token&quot;">​</a></h3><p>Read-only view of a cancellation state.</p><ul><li>Default constructed tokens are “empty” (non-cancelable).</li><li>Tokens are cheap to copy.</li><li>Tokens can be passed across threads safely.</li></ul><p>Methods:</p><ul><li><code>can_cancel()</code> returns true if it is linked to a source</li><li><code>is_cancelled()</code> returns true if cancellation has been requested</li></ul><h3 id="cancel-source" tabindex="-1">cancel_source <a class="header-anchor" href="#cancel-source" aria-label="Permalink to &quot;cancel_source&quot;">​</a></h3><p>Owner of the shared state.</p><ul><li>Constructing a source creates a new shared state.</li><li><code>token()</code> returns a <code>cancel_token</code> observing the same state.</li><li><code>request_cancel()</code> flips the flag (idempotent).</li><li><code>is_cancelled()</code> reads the flag.</li></ul><hr><h2 id="error-model" tabindex="-1">Error model <a class="header-anchor" href="#error-model" aria-label="Permalink to &quot;Error model&quot;">​</a></h2><p><code>cancelled_ec()</code> returns a standard error code representing a cancelled operation:</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">std</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::error_code ec </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> vix</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">core</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cancelled_ec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span></code></pre></div><p>It uses <code>make_error_code(errc::canceled)</code> from <code>vix/async/core/error.hpp</code>.</p><p>Use this when you want to return an explicit “canceled” status from functions that use error codes.</p><hr><h2 id="usage" tabindex="-1">Usage <a class="header-anchor" href="#usage" aria-label="Permalink to &quot;Usage&quot;">​</a></h2><h3 id="_1-basic-pattern-cooperative-loop" tabindex="-1">1) Basic pattern (cooperative loop) <a class="header-anchor" href="#_1-basic-pattern-cooperative-loop" aria-label="Permalink to &quot;1) Basic pattern (cooperative loop)&quot;">​</a></h3><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &lt;vix/async/core/cancel.hpp&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">using</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> vix</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">core</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::cancel_source;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">using</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> vix</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">core</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::cancel_token;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> do_work</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cancel_token</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> ct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ct.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">is_cancelled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">())</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ... do a chunk of work ...</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // keep chunks small enough that cancellation is responsive</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_2-cancel-from-another-thread" tabindex="-1">2) Cancel from another thread <a class="header-anchor" href="#_2-cancel-from-another-thread" aria-label="Permalink to &quot;2) Cancel from another thread&quot;">​</a></h3><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &lt;thread&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &lt;vix/async/core/cancel.hpp&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">using</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> vix</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">core</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::cancel_source;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> run</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  cancel_source src;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  auto</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tok </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> src.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">token</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  std</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::thread </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">worker</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">tok</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tok.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">is_cancelled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">())</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // work</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // later</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  src.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">request_cancel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  worker.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">join</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_3-return-cancellation-as-an-error-code" tabindex="-1">3) Return cancellation as an error code <a class="header-anchor" href="#_3-return-cancellation-as-an-error-code" aria-label="Permalink to &quot;3) Return cancellation as an error code&quot;">​</a></h3><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &lt;vix/async/core/cancel.hpp&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">using</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> vix</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">core</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::cancel_token;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">std</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error_code</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> read_something</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cancel_token</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> ct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (ct.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">is_cancelled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">())</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> vix</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">core</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cancelled_ec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // do work...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {};</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><hr><h2 id="notes-and-best-practices" tabindex="-1">Notes and best practices <a class="header-anchor" href="#notes-and-best-practices" aria-label="Permalink to &quot;Notes and best practices&quot;">​</a></h2><ul><li>Cancellation is cooperative: nothing is forcibly stopped. Your code must check the token.</li><li>Checkpoints matter: put checks at boundaries (loop iterations, before expensive steps, before blocking operations).</li><li>Empty tokens are valid: treat them as “never canceled” and proceed normally.</li><li><code>request_cancel()</code> is idempotent: calling it multiple times is fine.</li></ul><hr><h2 id="related" tabindex="-1">Related <a class="header-anchor" href="#related" aria-label="Permalink to &quot;Related&quot;">​</a></h2><ul><li><code>vix/async/core/error.hpp</code> provides the error category and <code>errc::canceled</code>.</li></ul>`,46)])])}const g=a(l,[["render",t]]);export{y as __pageData,g as default};
