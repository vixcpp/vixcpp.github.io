import{_ as s,o as e,c as a,a as t}from"./app.BhmzGfY0.js";import"./chunks/markjs.l6TISjdC.js";import"./chunks/minisearch.DigTKvvb.js";const g=JSON.parse('{"title":"Middleware (core)","description":"","frontmatter":{},"headers":[],"relativePath":"modules/core/middleware.md","filePath":"modules/core/middleware.md","lastUpdated":1770805184000}'),l={name:"modules/core/middleware.md"};function n(h,i,p,r,d,o){return e(),a("div",null,[...i[0]||(i[0]=[t(`<h1 id="middleware-core" tabindex="-1">Middleware (core) <a class="header-anchor" href="#middleware-core" aria-label="Permalink to &quot;Middleware (core)&quot;">​</a></h1><p>The middleware system in Vix provides a structured way to:</p><ul><li>intercept requests before they reach the handler</li><li>share data across layers (auth, logging, rate limiting, etc.)</li><li>standardize error handling</li><li>manage cross-cutting concerns cleanly</li></ul><p>It is built around five core concepts:</p><ul><li><code>Context</code></li><li><code>Services</code></li><li><code>Next</code></li><li><code>Hooks</code></li><li><code>Result</code> / <code>Error</code></li></ul><p>This document explains how they fit together.</p><hr><h2 id="_1-context" tabindex="-1">1. Context <a class="header-anchor" href="#_1-context" aria-label="Permalink to &quot;1. Context&quot;">​</a></h2><p><code>vix::mw::Context</code> is the object passed through the middleware pipeline.</p><p>It wraps:</p><ul><li>the current <code>Request</code></li><li>the current <code>ResponseWrapper</code></li><li>a shared <code>Services</code> container</li></ul><p>You use it to:</p><ul><li>read request data</li><li>write responses</li><li>access shared services</li><li>manage request-scoped state</li></ul><p>Example usage inside middleware:</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> my_middleware</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Context</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Next</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> next</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  auto&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> req </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">req</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  auto&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> res </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">res</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">req.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">has_header</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Authorization&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">send_error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">401</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;unauthorized&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Missing token&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  next</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // continue pipeline</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>The context is the single source of truth for the current request lifecycle.</p><hr><h2 id="_2-services" tabindex="-1">2. Services <a class="header-anchor" href="#_2-services" aria-label="Permalink to &quot;2. Services&quot;">​</a></h2><p><code>vix::mw::Services</code> is a lightweight dependency container.</p><p>It allows registering shared services by type:</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">services.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">provide</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">std</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">make_shared</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">MyDatabase</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;(...));</span></span></code></pre></div><p>And retrieving them inside middleware or handlers:</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">auto</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> db </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">services</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().get</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MyDatabase</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span></code></pre></div><p>Characteristics:</p><ul><li>type-safe</li><li>shared ownership via <code>std::shared_ptr</code></li><li>no string keys</li><li>minimal overhead</li></ul><p>It is designed for runtime services such as:</p><ul><li>database connections</li><li>configuration</li><li>external clients</li><li>caches</li></ul><hr><h2 id="_3-request-scoped-state" tabindex="-1">3. Request-Scoped State <a class="header-anchor" href="#_3-request-scoped-state" aria-label="Permalink to &quot;3. Request-Scoped State&quot;">​</a></h2><p>Request-scoped data should not live in global services.</p><p>Use <code>RequestState</code> through <code>Context</code>:</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ctx.emplace_state</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">User</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(User{</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">42</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Ada&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div><p>Later in the pipeline:</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">auto&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> user </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.state</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">User</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span></code></pre></div><p>This is ideal for:</p><ul><li>authenticated user info</li><li>correlation IDs</li><li>rate-limit metadata</li><li>validation results</li></ul><p>State is strongly typed and stored using <code>std::any</code> internally.</p><hr><h2 id="_4-next-continuation-control" tabindex="-1">4. Next (Continuation Control) <a class="header-anchor" href="#_4-next-continuation-control" aria-label="Permalink to &quot;4. Next (Continuation Control)&quot;">​</a></h2><p><code>vix::mw::Next</code> is a call-once continuation object.</p><p>It guarantees that the next middleware in the chain can only be invoked once.</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> middleware</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Context</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Next</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> next</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // pre logic</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  next</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // continue</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // post logic (optional)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>Important properties:</p><ul><li>call-once semantics</li><li>safe against double invocation</li><li>explicit pipeline control</li></ul><p>If <code>next()</code> is not called, the pipeline stops.</p><hr><h2 id="_5-hooks" tabindex="-1">5. Hooks <a class="header-anchor" href="#_5-hooks" aria-label="Permalink to &quot;5. Hooks&quot;">​</a></h2><p><code>vix::mw::Hooks</code> provides lifecycle integration points:</p><ul><li><code>on_begin</code></li><li><code>on_end</code></li><li><code>on_error</code></li></ul><p>Hooks can be merged using <code>merge_hooks(...)</code>.</p><p>Execution order:</p><ul><li><code>on_begin</code>: forward order</li><li><code>on_end</code>: reverse order</li><li><code>on_error</code>: reverse order</li></ul><p>This ensures predictable stacking behavior similar to nested middleware layers.</p><p>Hooks are ideal for:</p><ul><li>logging</li><li>metrics</li><li>tracing</li><li>performance measurement</li></ul><hr><h2 id="_6-result-and-error" tabindex="-1">6. Result and Error <a class="header-anchor" href="#_6-result-and-error" aria-label="Permalink to &quot;6. Result and Error&quot;">​</a></h2><p><code>vix::mw::Result&lt;T&gt;</code> is a typed result container that holds either:</p><ul><li>a value of type <code>T</code></li><li>an <code>Error</code></li></ul><p><code>Error</code> contains:</p><ul><li>HTTP status</li><li>machine-readable code</li><li>human-readable message</li><li>optional details map</li></ul><p>Example:</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> vix</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mw</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fail</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">401</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;unauthorized&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Invalid token&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><p>Or:</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> vix</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mw</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ok</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(User{...});</span></span></code></pre></div><p>This pattern encourages explicit error handling without exceptions.</p><p><code>Result&lt;void&gt;</code> is supported for side-effect operations.</p><hr><h2 id="_7-standard-error-model" tabindex="-1">7. Standard Error Model <a class="header-anchor" href="#_7-standard-error-model" aria-label="Permalink to &quot;7. Standard Error Model&quot;">​</a></h2><p>The middleware error model standardizes JSON error responses:</p><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;status&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">401</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;code&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;unauthorized&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;message&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Invalid token&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;details&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>Helper constructors exist for common HTTP errors:</p><ul><li><code>bad_request()</code></li><li><code>unauthorized()</code></li><li><code>forbidden()</code></li><li><code>not_found()</code></li><li><code>conflict()</code></li><li><code>internal()</code></li><li>etc.</li></ul><p>Errors are normalized to ensure valid status codes.</p><hr><h2 id="_8-typical-middleware-flow" tabindex="-1">8. Typical Middleware Flow <a class="header-anchor" href="#_8-typical-middleware-flow" aria-label="Permalink to &quot;8. Typical Middleware Flow&quot;">​</a></h2><ol><li>Request arrives.</li><li>Context is created.</li><li><code>on_begin</code> hooks execute.</li><li>Middleware chain runs.</li><li>Handler executes.</li><li><code>on_end</code> hooks execute.</li><li>If an error occurs, <code>on_error</code> hooks run.</li></ol><p>This guarantees structured lifecycle behavior.</p><hr><h2 id="design-philosophy" tabindex="-1">Design Philosophy <a class="header-anchor" href="#design-philosophy" aria-label="Permalink to &quot;Design Philosophy&quot;">​</a></h2><p>The Vix middleware layer is:</p><ul><li>explicit</li><li>minimal</li><li>strongly typed</li><li>deterministic in order</li><li>safe under composition</li></ul><p>It avoids:</p><ul><li>hidden global state</li><li>magic injection</li><li>implicit execution order</li><li>runtime reflection</li></ul><p>The result is a predictable pipeline suitable for both small services and large structured systems.</p><hr><h2 id="when-to-use-middleware" tabindex="-1">When to Use Middleware <a class="header-anchor" href="#when-to-use-middleware" aria-label="Permalink to &quot;When to Use Middleware&quot;">​</a></h2><p>Use middleware for:</p><ul><li>authentication</li><li>authorization</li><li>request validation</li><li>rate limiting</li><li>logging</li><li>tracing</li><li>CORS handling</li><li>request enrichment</li></ul><p>Avoid putting business logic in middleware. Keep it in handlers.</p><hr><h2 id="summary" tabindex="-1">Summary <a class="header-anchor" href="#summary" aria-label="Permalink to &quot;Summary&quot;">​</a></h2><p>The middleware system provides:</p><ul><li>structured request lifecycle control</li><li>typed dependency injection</li><li>typed request-scoped storage</li><li>explicit continuation control</li><li>standardized error handling</li></ul><p>It is designed to remain simple while scaling to complex applications.</p>`,95)])])}const u=s(l,[["render",n]]);export{g as __pageData,u as default};
