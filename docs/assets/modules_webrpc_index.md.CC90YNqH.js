import{_ as i,o as a,c as e,a as t}from"./app.DDe5_nNA.js";import"./chunks/markjs.l6TISjdC.js";import"./chunks/minisearch.DigTKvvb.js";const u=JSON.parse('{"title":"WebRPC Guide","description":"","frontmatter":{},"headers":[],"relativePath":"modules/webrpc/index.md","filePath":"modules/webrpc/index.md","lastUpdated":1770827001000}'),n={name:"modules/webrpc/index.md"};function l(h,s,p,r,o,k){return a(),e("div",null,[...s[0]||(s[0]=[t(`<h1 id="webrpc-guide" tabindex="-1">WebRPC Guide <a class="header-anchor" href="#webrpc-guide" aria-label="Permalink to &quot;WebRPC Guide&quot;">​</a></h1><p>This guide explains how to use <code>vix::webrpc</code> to build a small, explicit RPC layer.</p><p>WebRPC is transport-agnostic. It does not care if your payload comes from HTTP, WebSocket, P2P, or CLI. Your transport layer should only translate bytes to <code>vix::json::token</code>, call WebRPC, then translate the response back to bytes.</p><hr><h2 id="what-you-build-with-webrpc" tabindex="-1">What you build with WebRPC <a class="header-anchor" href="#what-you-build-with-webrpc" aria-label="Permalink to &quot;What you build with WebRPC&quot;">​</a></h2><p>A typical setup has three layers:</p><ol><li><strong>Envelope</strong>: <code>RpcRequest</code> and <code>RpcResponse</code> define what a call looks like.</li><li><strong>Methods</strong>: <code>Router</code> registers method handlers and executes them.</li><li><strong>Orchestration</strong>: <code>Dispatcher</code> adds notification and batch support, and produces response envelopes.</li></ol><p>Inside handlers you get a <strong>Context</strong> which is a read-only view of the request.</p><hr><h2 id="request-shape" tabindex="-1">Request shape <a class="header-anchor" href="#request-shape" aria-label="Permalink to &quot;Request shape&quot;">​</a></h2><p>A request is a JSON object token:</p><ul><li><code>method</code> (required, non-empty string)</li><li><code>id</code> (optional; null or missing means notification)</li><li><code>params</code> (optional; any JSON-like token)</li></ul><p>Example:</p><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{ </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;method&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ping&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;params&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;msg&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;hello&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } }</span></span></code></pre></div><hr><h2 id="step-1-parse-a-request" tabindex="-1">Step 1: Parse a request <a class="header-anchor" href="#step-1-parse-a-request" aria-label="Permalink to &quot;Step 1: Parse a request&quot;">​</a></h2><p>When you want to validate a raw token and inspect fields, use <code>RpcRequest::parse()</code>.</p><p>Key points:</p><ul><li>Parsing returns a value, not exceptions.</li><li>On failure you get a structured <code>RpcError</code>.</li><li>Use <code>has_id()</code> to detect request vs notification.</li></ul><p>Minimal pattern:</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">auto</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> parsed </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> RpcRequest</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">parse</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(raw);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">std</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">holds_alternative</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">RpcError</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;(parsed)) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // handle parse error</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">RpcRequest req </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> std</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">RpcRequest</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;(parsed);</span></span></code></pre></div><p>For a complete runnable example, see the examples file below.</p><hr><h2 id="step-2-register-methods-with-router" tabindex="-1">Step 2: Register methods with Router <a class="header-anchor" href="#step-2-register-methods-with-router" aria-label="Permalink to &quot;Step 2: Register methods with Router&quot;">​</a></h2><p>A WebRPC method is a handler:</p><ul><li>Input: <code>const Context&amp;</code></li><li>Output: <code>RpcResult</code> which is <code>variant&lt;token, RpcError&gt;</code></li></ul><p>Guidelines for a good handler:</p><ul><li>Validate <code>params</code> shape first (object vs array vs null).</li><li>Read fields using safe helpers like <code>get_i64_or</code>, <code>get_string_or</code>.</li><li>Return <code>RpcError::invalid_params(...)</code> when input does not match your contract.</li></ul><p>Minimal pattern:</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;math.add&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, [](</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Context</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) -&gt; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RpcResult</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> auto*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> p </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">params_object_ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">p) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> RpcError</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">invalid_params</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;params must be object&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> vix</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">obj</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;sum&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, p-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get_i64_or</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;a&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> p-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get_i64_or</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;b&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div><p>Router can dispatch a single raw request object:</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">RpcResult out </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">dispatch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(raw_request_token);</span></span></code></pre></div><hr><h2 id="step-3-use-dispatcher-for-real-transports" tabindex="-1">Step 3: Use Dispatcher for real transports <a class="header-anchor" href="#step-3-use-dispatcher-for-real-transports" aria-label="Permalink to &quot;Step 3: Use Dispatcher for real transports&quot;">​</a></h2><p><code>Dispatcher</code> is the recommended entry point for HTTP, WebSocket, or P2P integrations.</p><p>It handles:</p><ul><li>Parsing envelopes</li><li>Notifications (no id -&gt; no response)</li><li>Batch requests (array of request objects)</li><li>Wrapping results into <code>RpcResponse</code> JSON</li></ul><p>You call:</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Dispatcher</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> d</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">router</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">auto</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> response </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> d.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">handle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(payload_token, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;http&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">meta);</span></span></code></pre></div><p>Return value:</p><ul><li><code>std::nullopt</code> when no response should be sent (notification only)</li><li>Otherwise a <code>token</code> representing a response object or an array of responses</li></ul><hr><h2 id="notifications" tabindex="-1">Notifications <a class="header-anchor" href="#notifications" aria-label="Permalink to &quot;Notifications&quot;">​</a></h2><p>A notification is a call without <code>id</code> (or <code>id = null</code>).</p><p>Rules:</p><ul><li>Handler runs.</li><li>No response is produced.</li></ul><p>Use notifications for fire-and-forget operations like logs, telemetry, presence.</p><hr><h2 id="batch-requests" tabindex="-1">Batch requests <a class="header-anchor" href="#batch-requests" aria-label="Permalink to &quot;Batch requests&quot;">​</a></h2><p>A batch is an array of request objects.</p><p>Rules:</p><ul><li>Each item with an id yields a response entry.</li><li>Notifications yield no response entry.</li><li>If every item is a notification, the dispatcher returns no response.</li><li>Empty batch is invalid and yields an error response with <code>id = null</code>.</li></ul><p>Batch is useful when latency is high and you want fewer round-trips.</p><hr><h2 id="what-goes-in-transport-code" tabindex="-1">What goes in transport code <a class="header-anchor" href="#what-goes-in-transport-code" aria-label="Permalink to &quot;What goes in transport code&quot;">​</a></h2><p>Keep the transport adapter thin:</p><ol><li>Receive bytes</li><li>Parse into <code>vix::json::token</code></li><li>Call <code>Dispatcher::handle(payload, transport, meta)</code></li><li>If a response exists, serialize it and send it back</li></ol><p>Business logic lives in handlers, not in the transport.</p>`,58)])])}const g=i(n,[["render",l]]);export{u as __pageData,g as default};
